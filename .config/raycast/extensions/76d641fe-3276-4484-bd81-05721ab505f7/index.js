"use strict";var Q=Object.create;var C=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var oe=(e,t)=>{for(var i in t)C(e,i,{get:t[i],enumerable:!0})},D=(e,t,i,f)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of Z(t))!te.call(e,l)&&l!==i&&C(e,l,{get:()=>t[l],enumerable:!(f=X(t,l))||f.enumerable});return e};var ie=(e,t,i)=>(i=e!=null?Q(ee(e)):{},D(t||!e||!e.__esModule?C(i,"default",{value:e,enumerable:!0}):i,e)),re=e=>D(C({},"__esModule",{value:!0}),e);var me={};oe(me,{default:()=>Y});module.exports=re(me);var r=require("@raycast/api"),m=require("react");var z=require("@raycast/api"),I={best_quality:{crf:23,bitrate:"3000k",bufsize:"6000k"},balanced:{crf:28,bitrate:"2000k",bufsize:"4000k"},small_file:{crf:35,bitrate:"1000k",bufsize:"2000k"},very_small_file:{crf:42,bitrate:"500k",bufsize:"1000k"}},L="balanced",v=["mp4","mov","avi","mkv","webm","gif"],H=[".","/bin","~/.bin","/usr/bin","/usr/gnu/bin","/usr/local/bin","/opt/homebrew/bin","/opt/homebrew/sbin","/usr/local/Cellar/ffmpeg"].join(":"),w=(0,z.getPreferenceValues)().ffmpeg_path??"/opt/homebrew/bin/ffmpeg";var u=require("@raycast/api"),T=require("child_process"),P=ie(require("fs")),V=require("util");var se=()=>{try{return(0,P.existsSync)(w)}catch{return!1}},ne=()=>{try{return!!(0,T.execSync)(`zsh -l -c 'PATH=${H} ffmpeg -version'`).toString().includes("ffmpeg version")}catch{return!1}};function K(e){return e.replace(/^file:\/\//,"").replace(/%20/g," ")}function A(e){return e.split("/").pop()}function x(e){return[...new Set(e)]}function _(e){return P.default.existsSync(e)}var le=e=>{let t=ne(),i=se();return t?`zsh -l -c 'PATH=${H} ffmpeg ${e}'`:i?`${w} ${e}`:((0,u.showToast)({title:"Error",message:"FFmpeg is not installed. Please install FFmpeg or specify its path in the extension settings.",style:u.Toast.Style.Failure}),null)};function M(e){return e.replace(/\\/g,"\\\\").replace(/ /g,"\\ ").replace(/`/g,"\\`").replace(/"/g,'\\"').replace(/\$/g,"\\$").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}async function q(e,t){let i=e.length===1;await(0,u.showToast)(u.Toast.Style.Animated,i?"Compressing video...":"Compressing videos...");let l=(await Promise.all(e.map(async d=>{let g=d.replace(/\.\w+$/,` (yafw ${t}).mp4`),{crf:y,bitrate:h,bufsize:s}=I[t],a=le(`-y -i ${M(d)} -vcodec libx264 -crf ${y} -b:v ${h} -bufsize ${s} ${M(g)}`);return a?(0,V.promisify)(T.exec)(a).then(({stdout:N,stderr:R})=>(console.log(N),console.log(R),g)):[]}))).filter(Boolean);return l.length!==e.length?(0,u.showToast)({title:"Error",message:"Some files could not be compressed.",style:u.Toast.Style.Failure}):(0,u.showToast)({title:"Success",message:"Successfully compressed all files.",style:u.Toast.Style.Success}),l}function B(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function E(e){let t=e.toLowerCase();return v.some(i=>t.endsWith(i))}var n=require("@raycast/api"),S=require("react");var $=require("@raycast/api");var G="videos-history",ae=1e3*60*60*24*7;function ce({timestamp:e}){return Date.now()-e<ae}async function k(e){let t=e.map(i=>({file:i,timestamp:Date.now()}));return $.LocalStorage.setItem(G,JSON.stringify(t))}async function U(){let e=await $.LocalStorage.getItem(G);return!e||typeof e!="string"?null:JSON.parse(e).filter(ce).map(i=>i.file).filter(_)}var c=require("react/jsx-runtime");function J(e){let[t,i]=(0,S.useState)(null),[f,l]=(0,S.useState)(e.files),[d,g]=(0,S.useState)(!0);(0,S.useEffect)(()=>{U().then(s=>{i(s||[])}).finally(()=>g(!1))},[]),(0,S.useEffect)(()=>{if(t){let s=[...e.files,...t];l(s),k(s)}},[t,e.files]);let y=s=>{k(f.filter(a=>a!==s)),l(f.filter(a=>a!==s))},h=()=>{k([]),l([])};return(0,c.jsx)(n.Grid,{isLoading:d,children:x(f).map((s,a)=>(0,c.jsx)(n.Grid.Item,{id:a.toString(),title:A(s),content:{fileIcon:s},quickLook:{path:s},accessory:a<e.files.length?{icon:{source:n.Icon.Checkmark,tintColor:"#008080"}}:void 0,actions:(0,c.jsxs)(n.ActionPanel,{children:[(0,c.jsx)(n.Action.CopyToClipboard,{content:{file:s}}),(0,c.jsx)(n.Action.ToggleQuickLook,{}),(0,c.jsx)(n.Action.Open,{title:"Open",target:s}),(0,c.jsx)(n.Action.OpenWith,{path:s}),(0,c.jsx)(n.Action,{title:"Open in Finder",onAction:()=>(0,n.showInFinder)(s),icon:{source:n.Icon.Finder}}),(0,c.jsx)(n.Action,{title:"Remove From History",style:n.Action.Style.Destructive,onAction:()=>y(s),icon:{source:n.Icon.Trash}}),(0,c.jsx)(n.Action,{title:"Clear All History",style:n.Action.Style.Destructive,onAction:h,icon:{source:n.Icon.Trash}})]})},s))})}var p=require("react/jsx-runtime");function Y(){let[e,t]=(0,m.useState)([]),[i,f]=(0,m.useState)([]),[l,d]=(0,m.useState)(null),[g,y]=(0,m.useState)(null),[h,s]=(0,m.useState)(!1),[a,N]=(0,m.useState)(L),R=(0,r.useNavigation)(),O=(o,F=!1)=>{if(o=x(o.map(K)),o.length<e.length){let b=e.find(W=>!o.includes(W));f([...i,b])}else F?(s(!0),o=o.filter(b=>!i.includes(b))):f(i.filter(b=>!o.includes(b)));return o=o.filter(_),t(o)};(0,m.useEffect)(()=>{(()=>{r.Clipboard.read().then(d),(0,r.getSelectedFinderItems)().then(y).catch(()=>y([]))})()},[d,y]),(0,m.useEffect)(()=>{l&&"file"in l&&!e.includes(l.file)&&l.file&&E(l.file)&&O([...e,l.file],!0)},[l]),(0,m.useEffect)(()=>{if(g)for(let o of g)o.path&&E(o.path)&&O([...e,o.path],!0)},[g]),(0,m.useEffect)(()=>{for(let o of e)if(!E(o)){(0,r.showToast)({title:"Invalid file",message:`The file "${A(o)}" is not a valid video file. Supported formats are: ${v.join(", ")}`,style:r.Toast.Style.Failure}),O(e.filter(F=>F!==o));return}},[e]);let j=async()=>{if(e.length===0){(0,r.showToast)({title:"Select videos first",style:r.Toast.Style.Failure});return}q(e,a).then(o=>{o.length!==0&&(o.forEach(F=>r.Clipboard.copy({file:F})),R.push((0,p.jsx)(J,{files:o})))})};return(0,p.jsxs)(r.Form,{isLoading:!l||!g,actions:(0,p.jsx)(r.ActionPanel,{children:(0,p.jsx)(r.Action.SubmitForm,{title:"Compress Files",onSubmit:j})}),children:[h&&e.length>0?(0,p.jsx)(r.Form.Description,{text:"\u2714\uFE0E Loaded files from your clipboard or Finder"}):(0,p.jsx)(r.Form.Description,{text:"You can also copy some videos or select them in the Finder and launch this command again"}),(0,p.jsx)(r.Form.FilePicker,{id:"files",value:e,onChange:O,allowMultipleSelection:!0,title:"Choose Video Files",info:"Any files you copy or select in the Finder will show up here"}),(0,p.jsx)(r.Form.Dropdown,{id:"compression",title:"Compression",value:a,onChange:o=>N(o),children:Object.keys(I).map(o=>(0,p.jsx)(r.Form.Dropdown.Item,{value:o,title:B(o)},o))})]})}
