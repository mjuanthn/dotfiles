"use strict";var it=Object.create;var O=Object.defineProperty;var ot=Object.getOwnPropertyDescriptor;var st=Object.getOwnPropertyNames;var nt=Object.getPrototypeOf,at=Object.prototype.hasOwnProperty;var lt=(r,t)=>{for(var e in t)O(r,e,{get:t[e],enumerable:!0})},H=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of st(t))!at.call(r,o)&&o!==e&&O(r,o,{get:()=>t[o],enumerable:!(i=ot(t,o))||i.enumerable});return r};var d=(r,t,e)=>(e=r!=null?it(nt(r)):{},H(t||!r||!r.__esModule?O(e,"default",{value:r,enumerable:!0}):e,r)),mt=r=>H(O({},"__esModule",{value:!0}),r);var pt={};lt(pt,{default:()=>rt});module.exports=mt(pt);var et=require("@raycast/api");var V=require("@raycast/api"),x=class extends Error{},A=class{constructor(t,e){this.files=t;this.operation=e}run=async()=>{let t=await this.files.list();if(t.length===0)throw new x;await this.operation(t),await(0,V.showHUD)("All Videos are Processed")}};var Y=require("child_process"),L=d(require("path"));var D=require("@raycast/api");var G=["mp4","mov","avi","mkv","webm","gif"],F=[".","/bin","~/.bin","/usr/bin","/usr/gnu/bin","/usr/local/bin","/opt/homebrew/bin","/opt/homebrew/sbin","/usr/local/Cellar/ffmpeg"].join(":"),b=(0,D.getPreferenceValues)().ffmpeg_path??"/opt/homebrew/bin/ffmpeg";var U=require("@raycast/api");function P(r){return r.replace(/\\/g,"\\\\").replace(/ /g,"\\ ").replace(/`/g,"\\`").replace(/"/g,'\\"').replace(/\$/g,"\\$").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}function K(r){let t=r.toLowerCase();return G.some(e=>t.endsWith(e))}var q=require("child_process"),w=class{constructor(t,e){this.foldersPath=t;this.fileName=e}path=()=>this.foldersPath;exists=()=>{try{return(0,q.execSync)(`zsh -l -c 'PATH=${this.path()} which ${this.fileName}'`),!0}catch{return!1}};command=t=>`zsh -l -c 'PATH=${this.path()} ${this.fileName} ${t}'`};var v=class extends Error{},N=class{constructor(t,e,i){this.ffprobe=t;this.callbacks=e;this.ffmpegBinary=i??new w([...F.split(":"),L.default.dirname(b)].filter(o=>!!o).join(":"),"ffmpeg")}ffmpegBinary;exec=async t=>{let{input:e,params:i,output:o}=t;if(e===o)throw new Error("Cannot override source");if(e.includes("ffmpeg"))throw new Error("Path to ffmpeg command included automatically. Start your command directly from arguments");if(this.ffmpegBinary.exists()===!1)throw new v;let s=await this.ffprobe.exec({input:e,params:["-v error","-show_entries format=duration","-of default=noprint_wrappers=1:nokey=1"]});return new Promise((n,l)=>{let m=parseFloat(s)*1e3*1e3,u=this.ffmpegBinary.command(["-y",`-i ${P(e)}`,...i??[],o?"-progress pipe:1":void 0,o?P(o):void 0].filter(a=>a!=null).join(" ")),f=(0,Y.exec)(u);f.stderr?.on("data",a=>{console.log("ffmpeg stderr",a)}),f.stdout?.on("data",a=>{console.log("ffmpeg stdout",a);let h=a.split(`
`),y;for(let _ of h)_.includes("out_time_ms=")&&(y=_.split("=")[1]);if(y!=null){let _=parseFloat(y);if(Number.isNaN(_))return;this.callbacks?.onProgressChange?.(parseFloat(y)/m)}}),f.on("error",a=>{console.error("ffmpeg process error:",a),l(a)}),f.on("exit",(a,h)=>{a===0?(console.log("Video creation completed successfully."),n()):(console.error(`ffmpeg process exited with code ${a} and signal ${h}`),l(new Error(`ffmpeg process exited with code ${a} and signal ${h}`)))})})}};var Q=require("@raycast/api"),C=d(require("path"));var W=d(require("fs")),J=d(require("fs/promises")),g=d(require("path")),p=class{constructor(t){this._path=t}path=()=>this._path;extension=()=>g.default.extname(this._path);name=()=>g.default.basename(this._path,this.extension());nextName=(t={})=>{let{extension:e,counter:i=0}=t,o=g.default.dirname(this._path),s=g.default.extname(this._path),n=g.default.basename(this._path,s),l=n.split(" "),m=l[l.length-1],u=parseInt(m,10),f=u.toString()===m&&Number.isNaN(u)===!1,a=l.slice(0,-1).join(" "),h=f?`${a} (${u+i+1})`:`${n} (${i+1})`,y=g.default.join(o,`${h}${e??s}`);return W.default.existsSync(y)?this.nextName({extension:e,counter:i+1}):`${h}${e??s}`};remove=async()=>{await J.default.rm(this.path())}};var E=class{constructor(t,e){this.ffmpeg=t;this.file=e}encode=async(t={})=>{let{width:e,height:i}=t,o=this.file.path(),s=C.default.dirname(o),n=C.default.join(s,this.file.nextName({extension:".gif"})),l=new p(C.default.join(Q.environment.supportPath,"palette.png")),m=30;try{await this.ffmpeg.exec({input:o,params:[`-vf "fps=${m},palettegen=stats_mode=diff"`],output:l.path()}),await this.ffmpeg.exec({input:o,params:[e&&!i?`-vf scale=${e}:-2`:void 0,!e&&i?`-vf scale=-2:${i}`:void 0,e&&i?`-vf scale=${e}:${i}`:void 0],output:n})}finally{await l.remove()}}};var c=d(require("path"));var B=class{constructor(t,e){this.ffmpeg=t;this.file=e}encode=async(t={})=>{let{preset:e,width:i,height:o,format:s}=t,n=this.file.path(),l=c.default.dirname(n),m=s?`.${s}`:c.default.extname(n),u=c.default.join(l,this.file.nextName({extension:m})),f=m==="webm"?"libvpx-vp9":"libx264",a=(()=>{switch(e){case"best-quality":return"10M";case"optimal":return"4M";case"smallest-size":return"2M";default:return"4M"}})();await this.ffmpeg.exec({input:n,params:[e!=null?`-c:v ${f} -b:v ${a}`:void 0,i&&!o?`-vf scale=${i}:-2`:void 0,!i&&o?`-vf scale=-2:${o}`:void 0,i&&o?`-vf scale=${i}:${o}`:void 0],output:u})};stabilize=async()=>{let t=this.file.path(),e=c.default.dirname(t),i=this.file.extension(),o=c.default.join(e,this.file.nextName({extension:i})),s=new p(c.default.join(e,"transforms.trf"));try{await this.ffmpeg.exec({input:t,params:[`-vf vidstabdetect=shakiness=4:accuracy=15:result="${s.path()}" -f null -`]}),await this.ffmpeg.exec({input:t,params:[`-vf vidstabtransform=smoothing=12:zoom=0:input="${s.path()}"`],output:o})}finally{await new p(c.default.join(e,"transforms.trf")).remove()}}};var X=require("child_process"),Z=d(require("path"));var $=class extends Error{},z=class{ffprobeBinary;constructor(t){this.ffprobeBinary=t??new w([...F.split(":"),Z.default.dirname(b)].filter(e=>!!e).join(":"),"ffprobe")}exec=async t=>{let{input:e,params:i}=t;if(e.includes("ffprobe"))throw new Error("Path to ffprobe command included automatically. Start your command directly from arguments");if(this.ffprobeBinary.exists()===!1)throw new $;let o=this.ffprobeBinary.command([...i??[],P(e)].filter(n=>n!=null).join(" "));return(0,X.execSync)(o).toString()}};var T=require("@raycast/api");var I=require("@raycast/api");var S=class extends Error{},M=class{list=async()=>{if((await(0,I.getFrontmostApplication)()).name!=="Finder")throw new S;return(await(0,I.getSelectedFinderItems)()).filter(i=>K(i.path)).map(i=>new p(i.path))}};var R=class{constructor(t,e){this.origin=t;this.toast=e}run=async()=>{try{await this.origin.run()}catch(t){if(t instanceof v||t instanceof $){await this.toast.show({title:"FFmpeg is not installed. Please install FFmpeg or specify its path in the extension settings.",style:T.Toast.Style.Failure});return}if(t instanceof S){await this.toast.show({title:"Please put Finder in focus and try again",style:T.Toast.Style.Failure});return}if(t instanceof x){await this.toast.show({title:"Please select any Video in Finder",style:T.Toast.Style.Failure});return}t instanceof Error&&(console.error(t),await this.toast.show({title:t.message,style:T.Toast.Style.Failure}))}}};var tt=require("@raycast/api");var k=class{constructor(t,e){this.origin=t;this.length=e}toString(){return this.origin.length<this.length?this.origin:this.origin.substring(0,this.length)+"..."}};var j=class{constructor(t){this.toast=t}currentTitle="";show=async t=>{if(this.currentTitle=t.title,this.toast!=null){t.title!=null&&(this.toast.title=t.title),t.style!=null&&(this.toast.style=t.style),t.primaryAction!=null&&(this.toast.primaryAction=t.primaryAction),t.secondaryAction!=null&&(this.toast.secondaryAction=t.secondaryAction);return}this.toast=await(0,tt.showToast)(t)};updateProgress=async t=>{let e=new k(this.currentTitle,40);if(this.toast==null)throw new Error("Toast is not visible. Use `toast.show(...)` before");this.toast.title=`${e} ${t}%`}};async function rt(r){let{format:t}=r.arguments,e=new j,i=new M,o=new N(new z,{onProgressChange:async s=>{await e.updateProgress(Math.round(s*100))}});await new R(new A(i,async s=>{for(let n of s){if(await e.show({title:`Converting "${n.name()}${n.extension()}"`,style:et.Toast.Style.Animated}),t==="gif"){await new E(o,n).encode();continue}await new B(o,n).encode({format:t})}}),e).run()}
