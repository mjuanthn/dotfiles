"use strict";var tt=Object.create;var O=Object.defineProperty;var et=Object.getOwnPropertyDescriptor;var rt=Object.getOwnPropertyNames;var it=Object.getPrototypeOf,ot=Object.prototype.hasOwnProperty;var st=(r,t)=>{for(var e in t)O(r,e,{get:t[e],enumerable:!0})},k=(r,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of rt(t))!ot.call(r,i)&&i!==e&&O(r,i,{get:()=>t[i],enumerable:!(o=et(t,i))||o.enumerable});return r};var y=(r,t,e)=>(e=r!=null?tt(it(r)):{},k(t||!r||!r.__esModule?O(e,"default",{value:r,enumerable:!0}):e,r)),nt=r=>k(O({},"__esModule",{value:!0}),r);var at={};st(at,{default:()=>Z});module.exports=nt(at);var X=require("@raycast/api");var H=require("@raycast/api"),x=class extends Error{},A=class{constructor(t,e){this.files=t;this.operation=e}run=async()=>{let t=await this.files.list();if(t.length===0)throw new x;await this.operation(t),await(0,H.showHUD)("All Videos are Processed")}};var K=require("child_process"),q=y(require("path"));var V=require("@raycast/api");var j=["mp4","mov","avi","mkv","webm","gif"],b=[".","/bin","~/.bin","/usr/bin","/usr/gnu/bin","/usr/local/bin","/opt/homebrew/bin","/opt/homebrew/sbin","/usr/local/Cellar/ffmpeg"].join(":"),F=(0,V.getPreferenceValues)().ffmpeg_path??"/opt/homebrew/bin/ffmpeg";var D=require("@raycast/api");function P(r){return r.replace(/\\/g,"\\\\").replace(/ /g,"\\ ").replace(/`/g,"\\`").replace(/"/g,'\\"').replace(/\$/g,"\\$").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}function U(r){let t=r.toLowerCase();return j.some(e=>t.endsWith(e))}var G=require("child_process"),w=class{constructor(t,e){this.foldersPath=t;this.fileName=e}path=()=>this.foldersPath;exists=()=>{try{return(0,G.execSync)(`zsh -l -c 'PATH=${this.path()} which ${this.fileName}'`),!0}catch{return!1}};command=t=>`zsh -l -c 'PATH=${this.path()} ${this.fileName} ${t}'`};var v=class extends Error{},N=class{constructor(t,e,o){this.ffprobe=t;this.callbacks=e;this.ffmpegBinary=o??new w([...b.split(":"),q.default.dirname(F)].filter(i=>!!i).join(":"),"ffmpeg")}ffmpegBinary;exec=async t=>{let{input:e,params:o,output:i}=t;if(e===i)throw new Error("Cannot override source");if(e.includes("ffmpeg"))throw new Error("Path to ffmpeg command included automatically. Start your command directly from arguments");if(this.ffmpegBinary.exists()===!1)throw new v;let n=await this.ffprobe.exec({input:e,params:["-v error","-show_entries format=duration","-of default=noprint_wrappers=1:nokey=1"]});return new Promise((a,l)=>{let c=parseFloat(n)*1e3*1e3,f=this.ffmpegBinary.command(["-y",`-i ${P(e)}`,...o??[],i?"-progress pipe:1":void 0,i?P(i):void 0].filter(s=>s!=null).join(" ")),m=(0,K.exec)(f);m.stderr?.on("data",s=>{console.log("ffmpeg stderr",s)}),m.stdout?.on("data",s=>{console.log("ffmpeg stdout",s);let u=s.split(`
`),g;for(let _ of u)_.includes("out_time_ms=")&&(g=_.split("=")[1]);if(g!=null){let _=parseFloat(g);if(Number.isNaN(_))return;this.callbacks?.onProgressChange?.(parseFloat(g)/c)}}),m.on("error",s=>{console.error("ffmpeg process error:",s),l(s)}),m.on("exit",(s,u)=>{s===0?(console.log("Video creation completed successfully."),a()):(console.error(`ffmpeg process exited with code ${s} and signal ${u}`),l(new Error(`ffmpeg process exited with code ${s} and signal ${u}`)))})})}};var p=y(require("path"));var Y=y(require("fs")),L=y(require("fs/promises")),h=y(require("path")),d=class{constructor(t){this._path=t}path=()=>this._path;extension=()=>h.default.extname(this._path);name=()=>h.default.basename(this._path,this.extension());nextName=(t={})=>{let{extension:e,counter:o=0}=t,i=h.default.dirname(this._path),n=h.default.extname(this._path),a=h.default.basename(this._path,n),l=a.split(" "),c=l[l.length-1],f=parseInt(c,10),m=f.toString()===c&&Number.isNaN(f)===!1,s=l.slice(0,-1).join(" "),u=m?`${s} (${f+o+1})`:`${a} (${o+1})`,g=h.default.join(i,`${u}${e??n}`);return Y.default.existsSync(g)?this.nextName({extension:e,counter:o+1}):`${u}${e??n}`};remove=async()=>{await L.default.rm(this.path())}};var E=class{constructor(t,e){this.ffmpeg=t;this.file=e}encode=async(t={})=>{let{preset:e,width:o,height:i,format:n}=t,a=this.file.path(),l=p.default.dirname(a),c=n?`.${n}`:p.default.extname(a),f=p.default.join(l,this.file.nextName({extension:c})),m=c==="webm"?"libvpx-vp9":"libx264",s=(()=>{switch(e){case"best-quality":return"10M";case"optimal":return"4M";case"smallest-size":return"2M";default:return"4M"}})();await this.ffmpeg.exec({input:a,params:[e!=null?`-c:v ${m} -b:v ${s}`:void 0,o&&!i?`-vf scale=${o}:-2`:void 0,!o&&i?`-vf scale=-2:${i}`:void 0,o&&i?`-vf scale=${o}:${i}`:void 0],output:f})};stabilize=async()=>{let t=this.file.path(),e=p.default.dirname(t),o=this.file.extension(),i=p.default.join(e,this.file.nextName({extension:o})),n=new d(p.default.join(e,"transforms.trf"));try{await this.ffmpeg.exec({input:t,params:[`-vf vidstabdetect=shakiness=4:accuracy=15:result="${n.path()}" -f null -`]}),await this.ffmpeg.exec({input:t,params:[`-vf vidstabtransform=smoothing=12:zoom=0:input="${n.path()}"`],output:i})}finally{await new d(p.default.join(e,"transforms.trf")).remove()}}};var W=require("child_process"),J=y(require("path"));var S=class extends Error{},C=class{ffprobeBinary;constructor(t){this.ffprobeBinary=t??new w([...b.split(":"),J.default.dirname(F)].filter(e=>!!e).join(":"),"ffprobe")}exec=async t=>{let{input:e,params:o}=t;if(e.includes("ffprobe"))throw new Error("Path to ffprobe command included automatically. Start your command directly from arguments");if(this.ffprobeBinary.exists()===!1)throw new S;let i=this.ffprobeBinary.command([...o??[],P(e)].filter(a=>a!=null).join(" "));return(0,W.execSync)(i).toString()}};var T=require("@raycast/api");var z=require("@raycast/api");var $=class extends Error{},B=class{list=async()=>{if((await(0,z.getFrontmostApplication)()).name!=="Finder")throw new $;return(await(0,z.getSelectedFinderItems)()).filter(o=>U(o.path)).map(o=>new d(o.path))}};var M=class{constructor(t,e){this.origin=t;this.toast=e}run=async()=>{try{await this.origin.run()}catch(t){if(t instanceof v||t instanceof S){await this.toast.show({title:"FFmpeg is not installed. Please install FFmpeg or specify its path in the extension settings.",style:T.Toast.Style.Failure});return}if(t instanceof $){await this.toast.show({title:"Please put Finder in focus and try again",style:T.Toast.Style.Failure});return}if(t instanceof x){await this.toast.show({title:"Please select any Video in Finder",style:T.Toast.Style.Failure});return}t instanceof Error&&(console.error(t),await this.toast.show({title:t.message,style:T.Toast.Style.Failure}))}}};var Q=require("@raycast/api");var I=class{constructor(t,e){this.origin=t;this.length=e}toString(){return this.origin.length<this.length?this.origin:this.origin.substring(0,this.length)+"..."}};var R=class{constructor(t){this.toast=t}currentTitle="";show=async t=>{if(this.currentTitle=t.title,this.toast!=null){t.title!=null&&(this.toast.title=t.title),t.style!=null&&(this.toast.style=t.style),t.primaryAction!=null&&(this.toast.primaryAction=t.primaryAction),t.secondaryAction!=null&&(this.toast.secondaryAction=t.secondaryAction);return}this.toast=await(0,Q.showToast)(t)};updateProgress=async t=>{let e=new I(this.currentTitle,40);if(this.toast==null)throw new Error("Toast is not visible. Use `toast.show(...)` before");this.toast.title=`${e} ${t}%`}};async function Z(){let r=new B,t=new R,e=new N(new C,{onProgressChange:async o=>{await t.updateProgress(Math.round(o*100))}});await new M(new A(r,async o=>{if(o.some(i=>i.extension()===".gif"))throw new Error("Does not applicable to GIFs yet");for(let i of o)await t.show({title:`Stabilizing "${i.name()}${i.extension()}"`,style:X.Toast.Style.Animated}),await new E(e,i).stabilize()}),t).run()}
