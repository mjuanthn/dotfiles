"use strict";var ot=Object.create;var O=Object.defineProperty;var st=Object.getOwnPropertyDescriptor;var nt=Object.getOwnPropertyNames;var at=Object.getPrototypeOf,lt=Object.prototype.hasOwnProperty;var mt=(r,t)=>{for(var e in t)O(r,e,{get:t[e],enumerable:!0})},D=(r,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of nt(t))!lt.call(r,i)&&i!==e&&O(r,i,{get:()=>t[i],enumerable:!(o=st(t,i))||o.enumerable});return r};var d=(r,t,e)=>(e=r!=null?ot(at(r)):{},D(t||!r||!r.__esModule?O(e,"default",{value:r,enumerable:!0}):e,r)),pt=r=>D(O({},"__esModule",{value:!0}),r);var ft={};mt(ft,{default:()=>it});module.exports=pt(ft);var V=require("@raycast/api");var G=require("@raycast/api"),x=class extends Error{},A=class{constructor(t,e){this.files=t;this.operation=e}run=async()=>{let t=await this.files.list();if(t.length===0)throw new x;await this.operation(t),await(0,G.showHUD)("All Videos are Processed")}};var W=require("child_process"),J=d(require("path"));var U=require("@raycast/api");var K=["mp4","mov","avi","mkv","webm","gif"],b=[".","/bin","~/.bin","/usr/bin","/usr/gnu/bin","/usr/local/bin","/opt/homebrew/bin","/opt/homebrew/sbin","/usr/local/Cellar/ffmpeg"].join(":"),F=(0,U.getPreferenceValues)().ffmpeg_path??"/opt/homebrew/bin/ffmpeg";var q=require("@raycast/api");function v(r){return r.replace(/\\/g,"\\\\").replace(/ /g,"\\ ").replace(/`/g,"\\`").replace(/"/g,'\\"').replace(/\$/g,"\\$").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}function Y(r){let t=r.toLowerCase();return K.some(e=>t.endsWith(e))}var L=require("child_process"),w=class{constructor(t,e){this.foldersPath=t;this.fileName=e}path=()=>this.foldersPath;exists=()=>{try{return(0,L.execSync)(`zsh -l -c 'PATH=${this.path()} which ${this.fileName}'`),!0}catch{return!1}};command=t=>`zsh -l -c 'PATH=${this.path()} ${this.fileName} ${t}'`};var P=class extends Error{},C=class{constructor(t,e,o){this.ffprobe=t;this.callbacks=e;this.ffmpegBinary=o??new w([...b.split(":"),J.default.dirname(F)].filter(i=>!!i).join(":"),"ffmpeg")}ffmpegBinary;exec=async t=>{let{input:e,params:o,output:i}=t;if(e===i)throw new Error("Cannot override source");if(e.includes("ffmpeg"))throw new Error("Path to ffmpeg command included automatically. Start your command directly from arguments");if(this.ffmpegBinary.exists()===!1)throw new P;let s=await this.ffprobe.exec({input:e,params:["-v error","-show_entries format=duration","-of default=noprint_wrappers=1:nokey=1"]});return new Promise((l,n)=>{let m=parseFloat(s)*1e3*1e3,u=this.ffmpegBinary.command(["-y",`-i ${v(e)}`,...o??[],i?"-progress pipe:1":void 0,i?v(i):void 0].filter(a=>a!=null).join(" ")),f=(0,W.exec)(u);f.stderr?.on("data",a=>{console.log("ffmpeg stderr",a)}),f.stdout?.on("data",a=>{console.log("ffmpeg stdout",a);let h=a.split(`
`),y;for(let N of h)N.includes("out_time_ms=")&&(y=N.split("=")[1]);if(y!=null){let N=parseFloat(y);if(Number.isNaN(N))return;this.callbacks?.onProgressChange?.(parseFloat(y)/m)}}),f.on("error",a=>{console.error("ffmpeg process error:",a),n(a)}),f.on("exit",(a,h)=>{a===0?(console.log("Video creation completed successfully."),l()):(console.error(`ffmpeg process exited with code ${a} and signal ${h}`),n(new Error(`ffmpeg process exited with code ${a} and signal ${h}`)))})})}};var Z=require("@raycast/api"),E=d(require("path"));var Q=d(require("fs")),X=d(require("fs/promises")),g=d(require("path")),p=class{constructor(t){this._path=t}path=()=>this._path;extension=()=>g.default.extname(this._path);name=()=>g.default.basename(this._path,this.extension());nextName=(t={})=>{let{extension:e,counter:o=0}=t,i=g.default.dirname(this._path),s=g.default.extname(this._path),l=g.default.basename(this._path,s),n=l.split(" "),m=n[n.length-1],u=parseInt(m,10),f=u.toString()===m&&Number.isNaN(u)===!1,a=n.slice(0,-1).join(" "),h=f?`${a} (${u+o+1})`:`${l} (${o+1})`,y=g.default.join(i,`${h}${e??s}`);return Q.default.existsSync(y)?this.nextName({extension:e,counter:o+1}):`${h}${e??s}`};remove=async()=>{await X.default.rm(this.path())}};var I=class{constructor(t,e){this.ffmpeg=t;this.file=e}encode=async(t={})=>{let{width:e,height:o}=t,i=this.file.path(),s=E.default.dirname(i),l=E.default.join(s,this.file.nextName({extension:".gif"})),n=new p(E.default.join(Z.environment.supportPath,"palette.png")),m=30;try{await this.ffmpeg.exec({input:i,params:[`-vf "fps=${m},palettegen=stats_mode=diff"`],output:n.path()}),await this.ffmpeg.exec({input:i,params:[e&&!o?`-vf scale=${e}:-2`:void 0,!e&&o?`-vf scale=-2:${o}`:void 0,e&&o?`-vf scale=${e}:${o}`:void 0],output:l})}finally{await n.remove()}}};var c=d(require("path"));var B=class{constructor(t,e){this.ffmpeg=t;this.file=e}encode=async(t={})=>{let{preset:e,width:o,height:i,format:s}=t,l=this.file.path(),n=c.default.dirname(l),m=s?`.${s}`:c.default.extname(l),u=c.default.join(n,this.file.nextName({extension:m})),f=m==="webm"?"libvpx-vp9":"libx264",a=(()=>{switch(e){case"best-quality":return"10M";case"optimal":return"4M";case"smallest-size":return"2M";default:return"4M"}})();await this.ffmpeg.exec({input:l,params:[e!=null?`-c:v ${f} -b:v ${a}`:void 0,o&&!i?`-vf scale=${o}:-2`:void 0,!o&&i?`-vf scale=-2:${i}`:void 0,o&&i?`-vf scale=${o}:${i}`:void 0],output:u})};stabilize=async()=>{let t=this.file.path(),e=c.default.dirname(t),o=this.file.extension(),i=c.default.join(e,this.file.nextName({extension:o})),s=new p(c.default.join(e,"transforms.trf"));try{await this.ffmpeg.exec({input:t,params:[`-vf vidstabdetect=shakiness=4:accuracy=15:result="${s.path()}" -f null -`]}),await this.ffmpeg.exec({input:t,params:[`-vf vidstabtransform=smoothing=12:zoom=0:input="${s.path()}"`],output:i})}finally{await new p(c.default.join(e,"transforms.trf")).remove()}}};var tt=require("child_process"),et=d(require("path"));var $=class extends Error{},z=class{ffprobeBinary;constructor(t){this.ffprobeBinary=t??new w([...b.split(":"),et.default.dirname(F)].filter(e=>!!e).join(":"),"ffprobe")}exec=async t=>{let{input:e,params:o}=t;if(e.includes("ffprobe"))throw new Error("Path to ffprobe command included automatically. Start your command directly from arguments");if(this.ffprobeBinary.exists()===!1)throw new $;let i=this.ffprobeBinary.command([...o??[],v(e)].filter(l=>l!=null).join(" "));return(0,tt.execSync)(i).toString()}};var S=class{constructor(t){this.value=t}toInt(){if(!this.value)return;let t=parseInt(this.value,10);if(!Number.isNaN(t))return t}};var _=require("@raycast/api");var R=require("@raycast/api");var T=class extends Error{},M=class{list=async()=>{if((await(0,R.getFrontmostApplication)()).name!=="Finder")throw new T;return(await(0,R.getSelectedFinderItems)()).filter(o=>Y(o.path)).map(o=>new p(o.path))}};var k=class{constructor(t,e){this.origin=t;this.toast=e}run=async()=>{try{await this.origin.run()}catch(t){if(t instanceof P||t instanceof $){await this.toast.show({title:"FFmpeg is not installed. Please install FFmpeg or specify its path in the extension settings.",style:_.Toast.Style.Failure});return}if(t instanceof T){await this.toast.show({title:"Please put Finder in focus and try again",style:_.Toast.Style.Failure});return}if(t instanceof x){await this.toast.show({title:"Please select any Video in Finder",style:_.Toast.Style.Failure});return}t instanceof Error&&(console.error(t),await this.toast.show({title:t.message,style:_.Toast.Style.Failure}))}}};var rt=require("@raycast/api");var H=class{constructor(t,e){this.origin=t;this.length=e}toString(){return this.origin.length<this.length?this.origin:this.origin.substring(0,this.length)+"..."}};var j=class{constructor(t){this.toast=t}currentTitle="";show=async t=>{if(this.currentTitle=t.title,this.toast!=null){t.title!=null&&(this.toast.title=t.title),t.style!=null&&(this.toast.style=t.style),t.primaryAction!=null&&(this.toast.primaryAction=t.primaryAction),t.secondaryAction!=null&&(this.toast.secondaryAction=t.secondaryAction);return}this.toast=await(0,rt.showToast)(t)};updateProgress=async t=>{let e=new H(this.currentTitle,40);if(this.toast==null)throw new Error("Toast is not visible. Use `toast.show(...)` before");this.toast.title=`${e} ${t}%`}};async function it(r){let t=new S(r.arguments.width),e=new S(r.arguments.height),o=new M,i=new j,s=new C(new z,{onProgressChange:async l=>{await i.updateProgress(Math.round(l*100))}});if(t.toInt()==null&&e.toInt()==null){await i.show({title:"Please specify Width or Height and they must both be numbers",style:V.Toast.Style.Failure});return}await new k(new A(o,async l=>{for(let n of l){if(await i.show({title:`Resizing "${n.name()}${n.extension()}"`,style:V.Toast.Style.Animated}),n.extension()===".gif"){await new I(s,n).encode({width:t.toInt(),height:e.toInt()});continue}await new B(s,n).encode({width:t.toInt(),height:e.toInt()})}}),i).run()}
